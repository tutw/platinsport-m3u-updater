name: Update Platinsport M3U

on:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  workflow_dispatch:  # Permite ejecucion manual

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium

      - name: Configure network
        run: |
          echo "Configurando red..."
          # Deshabilitar IPv6 para evitar errores ENETUNREACH
          sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1 || true
          sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1 || true
          echo "Configuracion de red completada"

      - name: Run scraper
        run: |
          echo "Ejecutando scraper..."
          python platinsport.py

      - name: Verify M3U file
        run: |
          if [ ! -f lista.m3u ]; then
            echo "Error: lista.m3u no fue generado"
            exit 1
          fi

          lines=$(wc -l < lista.m3u)
          echo "lista.m3u generado"
          echo "Lineas totales: $lines"

          # Contar canales (cada 2 lineas despues de #EXTM3U)
          channels=$((($lines - 1) / 2))
          echo "Canales totales: $channels"

          echo ""
          echo "Primeras 30 lineas de lista.m3u:"
          head -n 30 lista.m3u

          if [ "$lines" -lt 10 ]; then
            echo "M3U demasiado pequeno (menos de 10 lineas)"
            exit 1
          fi

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Anadir archivos
          git add lista.m3u || true
          git add debug/ || true

          # Verificar si hay cambios
          if git diff --quiet && git diff --staged --quiet; then
            echo "No hay cambios para commitear"
          else
            timestamp=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
            git commit -m "Actualizar lista.m3u - $timestamp" || true
            git push || true
            echo "Cambios commiteados y pusheados"
          fi

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-files-${{ github.run_number }}
          path: |
            debug/
            lista.m3u
          if-no-files-found: warn
          retention-days: 7
