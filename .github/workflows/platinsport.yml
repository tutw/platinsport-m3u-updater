name: Update Platinsport M3U

on:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  workflow_dispatch:

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium

      - name: Configure IPv6 (disable if problematic)
        run: |
          echo "üîß Configurando red..."
          # Deshabilitar IPv6 a nivel de sistema para evitar ENETUNREACH
          sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
          sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
          echo "‚úÖ IPv6 deshabilitado"

      - name: Run scraper
        run: |
          python platinsport.py

      - name: Verify M3U file
        run: |
          if [ ! -f lista.m3u ]; then
            echo "‚ùå Error: lista.m3u no fue generado"
            exit 1
          fi

          lines=$(wc -l < lista.m3u)
          echo "‚úÖ lista.m3u generado"
          echo "üìä L√≠neas: $lines"

          echo "üìÑ Primeras 60 l√≠neas:"
          head -n 60 lista.m3u

          if [ "$lines" -lt 10 ]; then
            echo "‚ùå M3U demasiado peque√±o"
            exit 1
          fi

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add lista.m3u debug/ || true

          if git diff --quiet && git diff --staged --quiet; then
            echo "‚úÖ No hay cambios"
          else
            git commit -m "üîÑ Actualizar lista.m3u - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || true
            git push || true
          fi

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-files-${{ github.run_number }}
          path: |
            debug/
            lista.m3u
          if-no-files-found: warn
          retention-days: 7
