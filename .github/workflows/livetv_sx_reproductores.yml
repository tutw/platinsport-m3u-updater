name: Extraer Reproductores LiveTV.sx

on:
  schedule:
    # Ejecutar cada 6 horas
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      max_eventos:
        description: 'NÃºmero mÃ¡ximo de eventos a procesar'
        required: false
        default: '50'
        type: string
      delay:
        description: 'Delay entre peticiones (segundos)'
        required: false
        default: '1.5'
        type: string
      output_branch:
        description: 'Rama donde guardar resultados'
        required: false
        default: 'reproductores'
        type: string

env:
  PYTHON_VERSION: '3.9'
  OUTPUT_DIR: 'output'

jobs:
  extraer-reproductores:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: ðŸ› ï¸ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml
        echo "âœ… Dependencias instaladas"
        
    - name: ðŸ“ Crear directorio de salida
      run: |
        mkdir -p ${{ env.OUTPUT_DIR }}
        echo "âœ… Directorio creado: ${{ env.OUTPUT_DIR }}"
        
    - name: ðŸŽ¯ Ejecutar extractor de reproductores
      run: |
        echo "ðŸš€ Iniciando extracciÃ³n de reproductores..."
        python script_lista_livetv_sx_reproductores.py \
          ${{ github.event.inputs.max_eventos || '50' }} \
          ${{ github.event.inputs.delay || '1.5' }}
        echo "âœ… ExtracciÃ³n completada"
        
    - name: ðŸ“Š Mostrar estadÃ­sticas
      run: |
        echo "ðŸ“ˆ EstadÃ­sticas de la ejecuciÃ³n:"
        if [ -f "${{ env.OUTPUT_DIR }}/estadisticas.json" ]; then
          cat ${{ env.OUTPUT_DIR }}/estadisticas.json
        fi
        echo ""
        echo "ðŸ“‹ Archivos generados:"
        ls -la ${{ env.OUTPUT_DIR }}/
        
    - name: ðŸ” Validar archivos generados
      run: |
        echo "ðŸ” Validando archivos generados..."
        
        # Verificar XML principal
        if [ -f "${{ env.OUTPUT_DIR }}/eventos_livetv_sx_con_reproductores.xml" ]; then
          echo "âœ… XML principal generado correctamente"
          xmllint --noout ${{ env.OUTPUT_DIR }}/eventos_livetv_sx_con_reproductores.xml || echo "âš ï¸ XML no vÃ¡lido"
        else
          echo "âŒ XML principal no encontrado"
          exit 1
        fi
        
        # Verificar JSON
        if [ -f "${{ env.OUTPUT_DIR }}/reproductores_detalle.json" ]; then
          echo "âœ… JSON detallado generado correctamente"
          python -m json.tool ${{ env.OUTPUT_DIR }}/reproductores_detalle.json > /dev/null || echo "âš ï¸ JSON no vÃ¡lido"
        else
          echo "âŒ JSON detallado no encontrado"
        fi
        
        # Verificar reporte
        if [ -f "${{ env.OUTPUT_DIR }}/reporte_extraccion.md" ]; then
          echo "âœ… Reporte generado correctamente"
        else
          echo "âŒ Reporte no encontrado"
        fi
        
    - name: ðŸ“¤ Subir artefactos
      uses: actions/upload-artifact@v3
      with:
        name: reproductores-livetv-sx-${{ github.run_number }}
        path: |
          ${{ env.OUTPUT_DIR }}/
        retention-days: 30
        
    - name: ðŸ”„ Actualizar rama de resultados
      if: github.event_name == 'schedule' || github.event.inputs.output_branch
      env:
        BRANCH_NAME: ${{ github.event.inputs.output_branch || 'reproductores' }}
      run: |
        echo "ðŸ”„ Actualizando rama: $BRANCH_NAME"
        
        # Configurar git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # Crear/cambiar a rama de resultados
        git checkout -b $BRANCH_NAME 2>/dev/null || git checkout $BRANCH_NAME
        
        # Copiar archivos nuevos
        cp -r ${{ env.OUTPUT_DIR }}/* . 2>/dev/null || true
        
        # Crear README para la rama
        cat > README.md << EOF
        # Reproductores ExtraÃ­dos de LiveTV.sx
        
        ## Ãšltima actualizaciÃ³n
        $(date)
        
        ## Archivos disponibles
        - \`eventos_livetv_sx_con_reproductores.xml\` - XML principal con reproductores
        - \`reproductores_detalle.json\` - Datos detallados en JSON
        - \`reporte_extraccion.md\` - Reporte de la extracciÃ³n
        - \`estadisticas.json\` - EstadÃ­sticas de ejecuciÃ³n
        
        ## AutomatizaciÃ³n
        Este contenido se actualiza automÃ¡ticamente cada 6 horas mediante GitHub Actions.
        
        ## Uso
        El XML principal puede ser usado directamente en aplicaciones de streaming.
        EOF
        
        # AÃ±adir cambios
        git add .
        
        # Hacer commit si hay cambios
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No hay cambios para commitear"
        else
          git commit -m "ðŸ”„ Actualizar reproductores - $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin $BRANCH_NAME
          echo "âœ… Cambios enviados a la rama $BRANCH_NAME"
        fi

  notificar-resultado:
    needs: extraer-reproductores
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“¢ Notificar resultado
      run: |
        if [ "${{ needs.extraer-reproductores.result }}" == "success" ]; then
          echo "âœ… ExtracciÃ³n de reproductores completada exitosamente"
          echo "ðŸŽ¯ Resultado: SUCCESS"
        else
          echo "âŒ Error en la extracciÃ³n de reproductores"
          echo "ðŸŽ¯ Resultado: FAILURE"
          exit 1
        fi
        
    - name: ðŸ“Š Resumen de ejecuciÃ³n
      run: |
        echo "ðŸ“Š RESUMEN DE EJECUCIÃ“N"
        echo "====================="
        echo "ðŸ• Iniciado: ${{ github.event.head_commit.timestamp || github.run_number }}"
        echo "ðŸƒ Ejecutor: ${{ github.actor }}"
        echo "ðŸŒ¿ Rama: ${{ github.ref }}"
        echo "ðŸ“ Evento: ${{ github.event_name }}"
        echo "ðŸ”¢ Run ID: ${{ github.run_id }}"
        echo "====================="
