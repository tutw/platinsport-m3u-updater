name: Procesar Listas M3U y XML

on:
  schedule:
    - cron: "0 * * * *"  # Cada hora en punto (UTC)
  workflow_dispatch:

jobs:
  procesar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Listar archivos antes de procesar
        run: ls -la

      - name: Procesar listas
        env:
          GOOGLE_API_KEY_LOGOS: ${{ secrets.GOOGLE_API_KEY_LOGOS }}
          GOOGLE_CX: ${{ secrets.GOOGLE_CX }}
        run: python procesar_lista.py

      - name: Listar archivos después de procesar
        run: ls -la

      - name: Subir archivo generado
        uses: actions/upload-artifact@v4
        with:
          name: listas-con-logos-google
          path: salida_listas_con_logos_google.xml

      - name: Commit de cambios
        run: |
          if [ -f "salida_listas_con_logos_google.xml" ]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            mv salida_listas_con_logos_google.xml listas_con_logos_google.xml
            git add listas_con_logos_google.xml
            git commit -m "Actualizar listas con logos" || echo "Sin cambios para commitear"
            git push
          else
            echo "No se encontró el archivo salida_listas_con_logos_google.xml"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
